## Description
A simple docker container exposing a http server on port `3000`.

* Supports http requests for testing routing
* Supports Prometheus for testing scraping
* Supports Postgres for testing database connectivity

## API
| Path | Description |
|------|-------------|
| `/health` | Returns OK |
| `/metrics` | Exposes metrics which can be generated by accessing `/` and `/logo.png` |
| `/postgres/read` | Returns an integer from a database |
| `/postgres/write` | Bumps the integer returned by `/postgres/read` |

## Configuration
### Environment variables
*
    ```yaml
    Name: DSN
    Format: postgres://username:password@host:5432/dbName
    Example: postgres://bobs:youruncle@postgres-server:5432/ranch
    Description: A data source name(DSN) refering to a Postgres instance
    ```
*
    ```yaml
    Name: DEBUG
    Syntax: true | false
    Example: true 
    Description: Defaults to false. Set to true to enable debug logging. 
    ```

### Terraform
See [documentation](tf/README.md) for configuration

### .gihub/workflows/release.yaml variables 
The `.github/workflows/release.yaml` uses a OIDC setup for allowing github to push images to AWS ECR.

OIDC is used because we want to:
* Avoid use of long-lived access keys, rather use one-time tokens between github and aws
* Don't authenticate via a user (by using AWS access keys)
* Good control on `assume-role` in terms of what a role have access to and can do in your account

If you have other needs in terms of pushing resources to AWS: update the `build-and-push` step (and the corresponding role in terraform)

#### Variables to update in .gihub/workflows/release.yaml
* `branches`: on which branch(es) do you want to push the image to ECR
* `aws-region`: the location of your infrastructure
* `ECR_REPOSITORY`: Name of ECR repository in AWS, created by okctl application 
* `repository`: The {organization}/{okct-config} repo containing your okctl IAC code
* `ref`: branch name you are using (main/master) for your IAC repo
* `DEPLOYMENT_FILE`: path to your application deployment patch
* The git commit message at the end of `jobs.update-iac-tag`

#### Variables in okct-hello repo
The following secrets are here named after environment (DEV) and the application it is connected to (OKCT_HELLO)
* `secrets.DEV_OKCTL_HELLO_ECR_PUSH_ROLE` - environment secret 
  * The full ARN for the role to assume when pushing the image, generated by terraform
  * ex: `arn:aws:iam::123456789:role/github_actions/okctl-hello-github-ecr-push`
* `secrets.DEV_OKCTL_HELLO_IAC_DEPLOY_KEY` - repository secret
  * See: https://docs.github.com/en/developers/overview/managing-deploy-keys
  * See: https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key
  * Note: keypair must be passwordless in order for the process to work
  * Add public key for DEV_OKCTL_HELLO_IAC_DEPLOY_KEY to your IAC repo as a deploy key, remember to tick the "write access" box
  * Add private key for DEV_OKCTL_HELLO_IAC_DEPLOY_KEY to your (this) hello-okcl repo as a repository secret